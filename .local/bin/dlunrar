#!/bin/sh

DIR=/var/lib/transmission/seed

EP_RE='S[0-9][0-9]E[0-9][0-9]'

filter() {
  case $(pwd) in
    */ep)
      grep -i $EP_RE
      ;;
    */mov)
      grep -i '\(BluRay\|WEB-DL\)' | grep -vi $EP_RE
      ;;
    *)
      cat >/dev/null
      ;;
  esac
}

extract() {
  local f

  while IFS=$(printf '\n') read f; do
    [ -f "$(unrar lb "$f")" ] || unrar x "$f"
  done
}

link() {
  local f

  while IFS=$(printf '\n') read f; do
    [ -e "$(basename "$f")" ] || ln -sv "$f" .
  done
}

find $DIR -maxdepth 3 -type f -name \*.rar | filter | extract

find $DIR -maxdepth 3 -type f -name \*.mkv | filter | link
