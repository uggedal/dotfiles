#!/bin/sh

DIR=/var/lib/transmission/seed

filter() {
  case $(pwd) in
    */ep)
      grep 'S[0-9][0-9]E[0-9][0-9]'
      ;;
    */mov)
      grep '\(BluRay\|WEB-DL\)'
      ;;
    *)
      cat >/dev/null
      ;;
  esac
}

extract() {
  local f

  while read f; do
    [ -f "$(unrar lb $f)" ] || unrar x $f
  done
}

link() {
  local f

  while read f; do
    [ -e "$(basename $f)" ] || ln -s $f .
  done
}

find $DIR -maxdepth 2 -type f -name \*.rar | filter | extract

find $DIR -maxdepth 2 -type f -name \*.mkv | filter | link
