#!/usr/bin/env bash

BATTERY=BAT0
ADAPTER=ADP1
_IFS=$IFS

(
  while true; do
    bat=/sys/class/power_supply/$BATTERY
    if [ -d $bat ]; then
      cap=$(expr \( 100 \* $(<$bat/energy_now) \) / $(<$bat/energy_full))
      charging=$(</sys/class/power_supply/$ADAPTER/online)
      printf 'B%s %s\n' $cap $charging > $PANEL_FIFO
    fi

    date +'T%Y-%m-%d %H:%M' > $PANEL_FIFO
    sleep 1
  done
) &

cat $PANEL_FIFO | (
  battery=''
  info=''
  dt=''
  while read -r line; do
    case $line in
      B*)
        bat="${line#?}"
        charging=${bat#* }
        cap=${bat% *}
        col=r
        [ $cap -lt 50 ] && col=0
        [ $cap -lt 30 ] && col=1
        [ $cap -lt 10 ] && col=2
        [ $charging -eq 1 ] && col=7
        battery="\\f$col$cap%\\fr"
        ;;
      T*)
        dt="${line#?}"
        ;;
      W*)
        info=''
        IFS=':'
        set -- ${line#?}
        while [ $# -gt 0 ]; do
          item=$1
          name=${item#?}
          case $item in
              [FO]*)
                  # focused desktop
                  info="$info\\u2\\b8 $name \\br\\ur "
                  ;;
              [Uu]*)
                  # urgent desktop
                  info="$info\\u2\\b8\\f2 $name \\br\\ur\\fr "
                  ;;
              o*)
                  # occupied desktop
                  info="$info $name  "
                  ;;
            esac
          shift
        done
        IFS=$_IFS
        ;;
    esac
    printf ' %s \\r%s  \\f9//\\fr  %s \n' "$info" "$battery" "$dt"
  done
) | bar &
