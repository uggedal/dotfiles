#!/usr/bin/env bash

FONT='DejaVu Sans'
SIZE=10
HEIGHT=16
BATTERY=BAT0
_IFS=$IFS

bspc desktop ^1 -n 1
bspc monitor -a 2 3 4 5 6

bspc rule -a MPlayer --floating
bspc rule -a mpv --floating
bspc rule -a Gimp --floating

bspc config top_padding $HEIGHT
bspc config border_width 1
bspc config window_gap 4
bspc config focused_border_color "#d0ccc0"
bspc config normal_border_color "#fdfaf6"

(
  bat=/sys/class/power_supply/$BATTERY
  cap=$(expr \( 100 \* $(<$bat/energy_now) \) / $(<$bat/energy_full))
  printf 'B%s%%\n' $cap > $PANEL_FIFO

  date +'T%Y-%m-%d %H:%M' > $PANEL_FIFO
  sleep 1
) &

cat $PANEL_FIFO | (
  battery=''
  info=''
  dt=''
  while read -r line; do
    case $line in
      B*)
        battery="${line#?}"
        ;;
      T*)
        dt="${line#?}"
        ;;
      W*)
        info=''
        IFS=':'
        set -- ${line#?}
        while [ $# -gt 0 ]; do
          item=$1
          name=${item#?}
          case $item in
              [FO]*)
                  # focused desktop
                  info="$info\\u2\\b8 $name \\br\\ur "
                  ;;
              [Uu]*)
                  # urgent desktop
                  info="$info\\u2\\b8\\f2 $name \\br\\ur\\fr "
                  ;;
              o*)
                  # occupied desktop
                  info="$info $name  "
                  ;;
            esac
          shift
        done
        IFS=$_IFS
        ;;
    esac
    printf '%s \\r%s %s \n' "$info" "$battery" "$dt"
  done
) | bar &
