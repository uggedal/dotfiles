#!/usr/bin/env bash

set -e

PROTO=git

VIM_PLUGINS=(
  'chriskempson/base16-vim    dffebc6'

  'pangloss/vim-javascript    22475fc'
  'tpope/vim-markdown         ec0abb3'
  'hail2u/vim-css3-syntax     012c1ba'
  'elzr/vim-json              3b3fa6b'

  'ervandew/supertab          2.0'
  'scrooloose/syntastic       3.0.0'
  'tpope/vim-characterize     d5ba608'
  'vim-scripts/IndexedSearch  070503'

  'vim-scripts/genutils       2.5'
  'uggedal/SelectBuf          2916b8f'
)

err() {
  printf "%-30s %s\n" $1 "$2" >&2
}

ensure_git() {
  local target=$1

  test -d $target/.git
}

ensure_remote() {
  local repo=$1
  local target=$2

  (cd $target && git remote show -n origin | grep -qE "Fetch URL.+${repo}")
}

ensure_repo() {
  local repo=$1
  local target=$2
  local version=$3

  if ! ensure_git $target || ! ensure_remote $repo $target; then
    rm -rf $target
    git clone -q $PROTO://github.com/$repo.git $target
  else
    (cd $target && git fetch -q)
  fi

  (cd $target && git checkout -q $version)
}

ensure_plugins() {
  local root=$1
  shift
  local plugins=("${@}")

  test -d $root || mkdir -p $root

  for plugin in "${plugins[@]}"; do
    local repo=${plugin%% *}
    local name=${repo##*/}
    local version=${plugin##* }

    ensure_repo $repo $root/$name $version
  done
}

status_repo() {
  local name=$1
  local repo=$2
  local target=$3
  local version=$4

  if ! ensure_git $target; then
    err $name 'not installed'
    return
  fi

  if ! ensure_remote $repo $target; then
    err $name "not using $repo remote"
    return
  fi

  if grep -q '^[0-9.]\+$' <<<$version; then
    local actual_version=$(cd $target && git describe --tags)
    test $actual_version = $version && return
  else
    local actual_version=$(cd $target && git rev-parse HEAD)
    local behind=$(cd $target && git rev-list --count origin...HEAD 2>/dev/null)

    if [ "$behind" -gt 0 ]; then
      err $name "behind upstream with $behind changes"
    fi

    grep -q "^$version" <<<$actual_version && return
  fi

  err $name "not updated to $version"
}

status_plugins() {
  local root=$1
  shift
  local plugins=("${@}")

  for plugin in "${plugins[@]}"; do
    local repo=${plugin%% *}
    local name=${repo##*/}
    local version=${plugin##* }

    status_repo $name $repo $root/$name $version
  done
}

case $1 in
  sync)
    if [ $# -eq 2 ] && [[ $2  =~ ^(git|https?)$ ]]; then
      PROTO=$2
    fi

    ensure_plugins "$HOME/.vim/bundle" "${VIM_PLUGINS[@]}"
  ;;
  status)
    status_plugins "$HOME/.vim/bundle" "${VIM_PLUGINS[@]}"
  ;;
  *)
    echo Usage: $(basename $0) '<sync [git|http|https]|status>'
    exit 64
  ;;
esac
