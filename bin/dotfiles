#!/usr/bin/env bash

set -e

# TODO: take proto as argv:
PROTO=git

ZSH_PLUGINS=(
  'zsh-users/zsh-completions 9cbd2b6762'
  'zsh-users/zsh-syntax-highlighting 0.1.3'
)

VIM_PLUGINS=(
  'ervandew/supertab 2.0'
  'scrooloose/syntastic 3.0.0'
)

ensure_repo() {
  local repo=$1
  local target=$2
  local version=$3

  if [ ! -d $target/.git ]; then
    git clone -q $PROTO://github.com/$repo.git $target
  else
    (cd $target && git fetch -q)
  fi

  (cd $target && git checkout -q $version)
}

ensure_plugins() {
  local root=$1
  shift
  local plugins=("${@}")

  test -d $root || mkdir -p $root

  for plugin in "${plugins[@]}"; do
    local repo=${plugin%% *}
    local name=${repo##*/}
    local version=${plugin##* }

    ensure_repo $repo $root/$name $version
  done
}

case $1 in
  sync)
    ensure_plugins "$HOME/.zsh/plugins" "${ZSH_PLUGINS[@]}"
    ensure_plugins "$HOME/.vim/bundle" "${VIM_PLUGINS[@]}"
  ;;
  ls)
    echo Not implemented
  ;;
  *)
    echo Usage: $(basename $0) '[sync|ls]'
    exit 64
  ;;
esac
